<?php include_once 'includes/header.php'; ?>
<?php include_once 'includes/nav.php'; ?>

<div id="page-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Post Comments</h1>

                <?php
                if (isset($_GET['id'])) {
                    $post_id = intval($_GET['id']);
                } else {
                    echo "<p>No post specified.</p>";
                    exit();
                }
                ?>

                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Author</th>
                            <th>Comment</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Approve</th>
                            <th>Unapprove</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $connection = $db->get_connection();
                        $query = "SELECT * FROM comments WHERE post_id = $post_id";
                        $select_comments = mysqli_query($connection, $query);

                        if (!$select_comments) {
                            die("QUERY FAILED: " . mysqli_error($connection));
                        }

                        $comments = mysqli_fetch_all($select_comments, MYSQLI_ASSOC);
                        echo "Number of comments fetched: " . count($comments); // Debugging line

                        if (count($comments) > 0) {
                            foreach ($comments as $comment) {
                                $comment_id = $comment['comment_id'];
                                $comment_author = htmlspecialchars($comment['comment_author']);
                                $comment_content = htmlspecialchars($comment['comment_content']);
                                $comment_email = htmlspecialchars($comment['comment_email']);
                                $comment_status = htmlspecialchars($comment['comment_status']);
                                $comment_date = htmlspecialchars($comment['comment_date']);

                                echo "<tr>";
                                echo "<td>$comment_id</td>";
                                echo "<td>$comment_author</td>";
                                echo "<td>$comment_content</td>";
                                echo "<td>$comment_email</td>";
                                echo "<td>$comment_status</td>";
                                echo "<td>$comment_date</td>";
                                echo "<td>
                                        <a href='post_comments.php?id=$post_id&approve={$comment_id}' class='btn btn-warning'>Approve</a>
                                      </td>";
                                echo "<td>
                                        <a href='post_comments.php?id=$post_id&unapprove={$comment_id}' class='btn btn-danger'>Unapprove</a>
                                      </td>";
                                echo "<td>
                                        <a href='post_comments.php?id=$post_id&delete={$comment_id}' class='btn btn-danger'>Delete</a>
                                      </td>";
                                echo "</tr>";
                            }
                        } else {
                            echo "<tr><td colspan='9'>No comments found.</td></tr>";
                        }
                        ?>
                    </tbody>
                </table>

                <?php
                // Approve comment
                if (isset($_GET['approve'])) {
                    $comment_id = intval($_GET['approve']);
                    $query = "UPDATE comments SET comment_status = 'approved' WHERE comment_id = $comment_id";
                    $approve_comment_query = mysqli_query($connection, $query);

                    if (!$approve_comment_query) {
                        die("QUERY FAILED: " . mysqli_error($connection));
                    }

                    echo "<script>window.location.href = 'post_comments.php?id=$post_id';</script>";
                    exit();
                }

                // Unapprove comment
                if (isset($_GET['unapprove'])) {
                    $comment_id = intval($_GET['unapprove']);
                    $query = "UPDATE comments SET comment_status = 'unapproved' WHERE comment_id = $comment_id";
                    $unapprove_comment_query = mysqli_query($connection, $query);

                    if (!$unapprove_comment_query) {
                        die("QUERY FAILED: " . mysqli_error($connection));
                    }

                    echo "<script>window.location.href = 'post_comments.php?id=$post_id';</script>";
                    exit();
                }

                // Delete comment
                if (isset($_GET['delete'])) {
                    $comment_id = intval($_GET['delete']);
                    $delete_query = "DELETE FROM comments WHERE comment_id = {$comment_id}";
                    $delete_comment = mysqli_query($connection, $delete_query);

                    if (!$delete_comment) {
                        die("QUERY FAILED: " . mysqli_error($connection));
                    }

                    echo "<script>window.location.href = 'post_comments.php?id=$post_id';</script>";
                    exit();
                }
                ?>
            </div>
        </div>
    </div>
</div>

<?php include_once 'includes/footer.php'; ?>
